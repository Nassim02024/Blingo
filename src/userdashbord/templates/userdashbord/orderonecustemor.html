{% extends "baseu.html" %}
{% load static %}
{% block content %}

<div class="row" >

    <h2>
        <a href='{% url "tables" %}'>
            <i class="bi bi-arrow-left-circle"></i>
        </a> Bill</h2>

    <div style="display: flex;flex-direction: column; justify-content: space-between; width: 100%;padding:20px;">
        
        <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
            <p>State</p>
            <p class=" state-product">{{order.product_status}}</p>
        </div>
        <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
            <p>Name</p>
            <p class=''>{{order.user}}</p>
        </div>
        <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
            <p>order Price</p>
            <span style="display:flex"><p class="summary_order_tolal"> 0.00 </p> <p>Dz</p></span>
            
        </div>
        
        <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
            <p>Delivery service </p>
            {# ğŸ’¡ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø¶Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Dz Ù‡Ù†Ø§ Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙÙŠ JS #}
            <p class="summary_Delivery_service">{{ order.delivry }} Dz</p> 
        </div>

        <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
            <h5>Total</h5> 
             <h5 class="summary_order_all">0.00 Dz</h5>
        </div>
        
    </div>
    <div class="col-12">
        {% for o in orders %}
        <center><h2>Order_by {{o.fullname}}</h2></center>
        {% endfor %}
        <div class="card mb-4">
            <div class="card-header pb-0">
                <h6>Projects table</h6>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
                <div class="table-responsive p-0">
                    <table class="table align-items-center justify-content-center mb-0">
                        <thead>
                            <tr>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Unit Price</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Quantity</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Total Price</th>
                                {% comment %} <th class="text-uppercase text-secondary text-xxs font-weight-bolder text-center opacity-7 ps-2">Completion</th> {% endcomment %}
                                <th></th>
                            </tr>
                        </thead>
                        
                        <tbody>
                            {% for item in items %}
                            {# ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© data-attributes Ù„Ù„ØµÙ #}
                            <tr class="product-row"
                                data-unit-price="{{ item.price }}"
                                data-quantity="{{ item.quantity }}">
                                <td>
                                    <div class="d-flex px-2">
                                        <div>
                                            <img src="{{item.image.url}}" class="avatar avatar-sm rounded-circle me-2" alt="small-logos" loading="lazy">
                                        </div>
                                        <div class="my-auto">
                                            <h6 class="mb-0 text-sm">{{item.product.title}}</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {# ğŸ’¡ Ù‡Ø°Ø§ Ø§Ù„Ø¢Ù† Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© #}
                                    <p class="text-sm font-weight-bold mb-0 unit-price-display">{{ item.price }} Dz</p> 
                                </td>
                                <td>
                                    <span class="text-xs font-weight-bold quantity-display">{{ item.quantity }}</span>
                                </td>
                                <td>
                                    {# ğŸ’¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù†ØµØ± (Ù…Ø­Ø³ÙˆØ¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…) Ù„Ù„ØªØ£ÙƒØ¯ØŒ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ÙŠØ­Ø³Ø¨Ù‡ JS #}
                                    <p class="text-sm font-weight-bold mb-0 item-total-display">{{ item.total }} Dz</p> 
                                </td>
                                {% comment %} <td class="align-middle text-center">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span class="me-2 text-xs font-weight-bold">60%</span>
                                        <div>
                                            <div class="progress">
                                                <div class="progress-bar bg-gradient-info" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td> {% endcomment %}
                                <td class="align-middle">
                                    <button class="btn btn-link text-secondary mb-0">
                                        <i class="fa fa-ellipsis-v text-xs"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="map" style="height:80vh"> </div>

    
</div>
{% block scripts %}
<script>

    //
    //
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmxpbmdvIiwiYSI6ImNtZjU5cHB1aDAzY3cya3M5Y3BuN291bjEifQ.fZnLg8Uql1f2NegnAp6Bdw';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v11',
        projection: 'globe',
        zoom: 11,
        center: [6.05796000 , 33.10527000],
    });
    
    // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„
    const lng_customer = parseFloat("{{ lng }}");
    const lat_customer = parseFloat("{{ lat }}");
    
    const markerCustomer = new mapboxgl.Marker()
        .setLngLat([lng_customer , lat_customer])
        .addTo(map);
    
    // marker Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
    const markerDelivery = new mapboxgl.Marker({ color: 'red', rotation: 45 })
        .setLngLat([0,0])
        .addTo(map);
    
    // Ø¥Ø¶Ø§ÙØ© route ÙØ§Ø±Øº
    map.on('load', () => {
        map.addSource('route', {
            'type': 'geojson',
            'data': {
                'type': 'Feature',
                'geometry': {
                    'type': 'LineString',
                    'coordinates': []
                }
            }
        });
    
        map.addLayer({
            'id': 'route',
            'type': 'line',
            'source': 'route',
            'layout': {
                'line-join': 'round',
                'line-cap': 'round'
            },
            'paint': {
                'line-color': '#0000FF',
                'line-width': 4
            }
        });
    });
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ù‚ Ù…Ù† Mapbox Directions API
    async function getRoute(origin, destination) {
        const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${origin[0]},${origin[1]};${destination[0]},${destination[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.routes && data.routes.length > 0) {
            return data.routes[0].geometry.coordinates;
        }
        return [];
    }
    
    // ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
    async function successCallback(pos) {
        const lng_delevery_man = pos.coords.longitude;
        const lat_delevery_man = pos.coords.latitude;
    
        // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
        markerDelivery.setLngLat([lng_delevery_man , lat_delevery_man]);
    
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±Ù‚
        const routeCoordinates = await getRoute(
            [lng_delevery_man, lat_delevery_man],
            [lng_customer, lat_customer]
        );
    
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        if (map.getSource('route')) {
            map.getSource('route').setData({
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: routeCoordinates
                }
            });
        }
    }
    
    function errorCallback(err) {
        console.warn(`ERROR(${err.code}): ${err.message}`);
    }
    
    // ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø¨Ø¯ÙˆÙ† ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    navigator.geolocation.watchPosition(successCallback, errorCallback, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });
    
//
//

// -------------------------------------------------------------
// âœ… ØªØ¹Ø¯ÙŠÙ„ ÙƒÙˆØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙŠØ£Ø®Ø° Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø±
// -------------------------------------------------------------

    let productRows = document.querySelectorAll('.product-row');
    let summary_order_tolal = document.querySelector('.summary_order_tolal');
    let summary_Delivery_service = document.querySelector('.summary_Delivery_service');
    let summary_order_all = document.querySelector('.summary_order_all');
    
    let totalProductsPrice = 0;

    productRows.forEach(row => {
        // ğŸ’¡ Ù‚Ø±Ø§Ø¡Ø© Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ù…Ù† Ø³Ù…Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹
        let price = parseFloat(row.dataset.unitPrice) || 0;
        let quantity = parseInt(row.dataset.quantity) || 0;
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø³Ø¹Ø± Ã— Ø§Ù„ÙƒÙ…ÙŠØ©)
        totalProductsPrice += (price * quantity);
    });

    let formattedTotal = totalProductsPrice.toFixed(2);
    
    // Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ ÙˆØªÙ†Ø¸ÙŠÙÙ‡Ø§ Ù…Ù† ' Dz'
    let deliveryPriceText = summary_Delivery_service ? summary_Delivery_service.innerText.replace(' Dz', '').trim() : '0';
    let deliveryPrice = parseFloat(deliveryPriceText) || 0;

    let orderAll = totalProductsPrice + deliveryPrice;
    let formattedOrderAll = orderAll.toFixed(2);

    
    if (summary_order_tolal) {
        // ğŸ’¡ Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ­ÙŠØ­
        summary_order_tolal.innerText = formattedTotal;
    } else {
        console.warn("âš ï¸ summary_order_tolal is not defined");
    }
    
    // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡Ø§ ØªØ¹Ø±Ø¶ Dz
    summary_Delivery_service.innerText = deliveryPrice.toFixed(2) + ' Dz';
    
    // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ
    if (summary_order_all) {
        summary_order_all.innerText = formattedOrderAll + ' Dz';
    }


</script>
{% endblock scripts %}

{% endblock content %}