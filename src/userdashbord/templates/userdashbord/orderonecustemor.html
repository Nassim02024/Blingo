{% extends "baseu.html" %}
{% load static %}
{% block content %}




<div class="row" >

  <h2>
    <a href='{% url "tables" %}'>
      <i class="bi bi-arrow-left-circle"></i>
    </a> Bill</h2>

<div  style="display: flex;flex-direction: column; justify-content: space-between; width: 100%;padding:20px;">
  
  <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>State</p>
     <p class=" state-product">{{order.product_status}}</p>
  </div>
  <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>Name</p>
     <p class=''>{{order.user}}</p>
  </div>
  <!-- <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>Email</p>
     <p class=''>{{request.user.email}}</p>
  </div> -->
  <!-- <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>Location</p>
     <p class=''>none</p>
  </div> -->
    
  <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>order Price</p>
     <span style="display:flex"><p class="summary_order_tolal">  </p> <p>Dz</p></span>
     
  </div>
  
  <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <p>Delivery service </p>
     <p class="summary_Delivery_service"> {{order.delivry}} </p>
  </div>

  <div class="summary" style="display: flex;justify-content: space-between; width: 100%">
     <h5>Total</h3> 
      <h5 class="summary_order_all">2300 </h5>
  </div>
  
</div>
  <div class="col-12">
    {% for o in orders %}
    <center><h2>Order_by {{o.fullname}}</h2></center>
    {% endfor %}
    <div class="card mb-4">
      <div class="card-header pb-0">
        <h6>Projects table</h6>
      </div>
      <div class="card-body px-0 pt-0 pb-2">
        <div class="table-responsive p-0">
          <table class="table align-items-center justify-content-center mb-0">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Budget</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Quantity</th>
                {% comment %} <th class="text-uppercase text-secondary text-xxs font-weight-bolder text-center opacity-7 ps-2">Completion</th> {% endcomment %}
                <th></th>
              </tr>
            </thead>
            
            <tbody>
              {% for item in items %}
              <tr>
                <td>
                  <div class="d-flex px-2">
                    <div>
                      <img src="{{item.image.url}}" class="avatar avatar-sm rounded-circle me-2" alt="small-logos" loading="lazy">
                    </div>
                    <div class="my-auto">
                      <h6 class="mb-0 text-sm">{{item.product.title}}</h6>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="text-sm font-weight-bold mb-0 price_one_product ">{{ item.price }}</p>
                </td>
                <td>
                  <span class="text-xs font-weight-bold">{{ item.quantity }}</span>
                </td>
                {% comment %} <td class="align-middle text-center">
                  <div class="d-flex align-items-center justify-content-center">
                    <span class="me-2 text-xs font-weight-bold">60%</span>
                    <div>
                      <div class="progress">
                        <div class="progress-bar bg-gradient-info" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%;"></div>
                      </div>
                    </div>
                  </div>
                </td> {% endcomment %}
                <td class="align-middle">
                  <button class="btn btn-link text-secondary mb-0">
                    <i class="fa fa-ellipsis-v text-xs"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="map" style="height:80vh"> </div>

  
</div>
{% block scripts %}
<script>

  //
  //
  mapboxgl.accessToken = 'pk.eyJ1IjoiYmxpbmdvIiwiYSI6ImNtZjU5cHB1aDAzY3cya3M5Y3BuN291bjEifQ.fZnLg8Uql1f2NegnAp6Bdw';
  const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/satellite-streets-v11',
      projection: 'globe',
      zoom: 11,
      center: [6.05796000 , 33.10527000],
  });
  
  // موقع العميل
  const lng_customer = parseFloat("{{ lng }}");
  const lat_customer = parseFloat("{{ lat }}");
  
  const markerCustomer = new mapboxgl.Marker()
      .setLngLat([lng_customer , lat_customer])
      .addTo(map);
  
  // marker للمندوب
  const markerDelivery = new mapboxgl.Marker({ color: 'red', rotation: 45 })
      .setLngLat([0,0])
      .addTo(map);
  
  // إضافة route فارغ
  map.on('load', () => {
      map.addSource('route', {
          'type': 'geojson',
          'data': {
              'type': 'Feature',
              'geometry': {
                  'type': 'LineString',
                  'coordinates': []
              }
          }
      });
  
      map.addLayer({
          'id': 'route',
          'type': 'line',
          'source': 'route',
          'layout': {
              'line-join': 'round',
              'line-cap': 'round'
          },
          'paint': {
              'line-color': '#0000FF',
              'line-width': 4
          }
      });
  });
  
  // دالة لجلب مسار على الطرق من Mapbox Directions API
  async function getRoute(origin, destination) {
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${origin[0]},${origin[1]};${destination[0]},${destination[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.routes && data.routes.length > 0) {
          return data.routes[0].geometry.coordinates;
      }
      return [];
  }
  
  // تتبع حركة المندوب
  async function successCallback(pos) {
      const lng_delevery_man = pos.coords.longitude;
      const lat_delevery_man = pos.coords.latitude;
  
      // تحديث موقع المندوب
      markerDelivery.setLngLat([lng_delevery_man , lat_delevery_man]);
  
      // جلب المسار الفعلي على الطرق
      const routeCoordinates = await getRoute(
          [lng_delevery_man, lat_delevery_man],
          [lng_customer, lat_customer]
      );
  
      // تحديث المسار على الخريطة
      if (map.getSource('route')) {
          map.getSource('route').setData({
              type: 'Feature',
              geometry: {
                  type: 'LineString',
                  coordinates: routeCoordinates
              }
          });
      }
  }
  
  function errorCallback(err) {
      console.warn(`ERROR(${err.code}): ${err.message}`);
  }
  
  // تتبع حركة المندوب بدون تحريك الكاميرا
  navigator.geolocation.watchPosition(successCallback, errorCallback, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
  });
  
//
//


  

  let price_one_product = document.querySelectorAll('.price_one_product')

  let summary_order_tolal = document.querySelector('.summary_order_tolal')
  let summary_Delivery_service = document.querySelector('.summary_Delivery_service')
  let summary_order_all = document.querySelector('.summary_order_all')
  
  let total = 0
  price_one_product.forEach(element => {
    total += parseInt(element.innerText)
  });
  
  let deliveryPrice = document.querySelector('.summary_Delivery_service').innerText
  
  if (summary_order_tolal) {
    summary_order_tolal.innerText = total;
  } else {
    console.warn("⚠️" + " summary_order_tolal is not defined");
  }
  
  summary_Delivery_service.innerText = parseInt(deliveryPrice) + ' Dz';
  summary_order_all.innerText = (total + parseInt(deliveryPrice)) + ' Dz';
  



</script>
{% endblock  %}

{% endblock content %}